<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#faf5ff',
              100: '#f3e8ff',
              200: '#e9d5ff',
              300: '#d8b4fe',
              400: '#c084fc',
              500: '#a855f7',
              600: '#9333ea',
              700: '#7e22ce',
              800: '#6b21a8',
              900: '#581c87',
            }
          },
          fontFamily: {
            sans: ['Lato', 'ui-sans-serif', 'system-ui'],
          },
        }
      }
    }
  </script>

  <style>
    /* Improved voice recognition styles */
    .voice-listening {
      animation: voice-pulse 1s ease-in-out infinite;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
    }

    @keyframes voice-pulse {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
      }

      50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.5);
      }
    }

    /* --- NEW WAVE ANIMATION CSS --- */
    .voice-wave-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 20px;
    }

    .wave-bar {
      width: 4px;
      background: #9333ea;
      /* Primary purple color */
      border-radius: 4px;
      animation: wave-animation 1s ease-in-out infinite;
    }

    /* Different delays to create the wave effect */
    .wave-bar:nth-child(1) {
      animation-delay: 0.0s;
      height: 40%;
    }

    .wave-bar:nth-child(2) {
      animation-delay: 0.1s;
      height: 50%;
    }

    .wave-bar:nth-child(3) {
      animation-delay: 0.2s;
      height: 100%;
    }

    .wave-bar:nth-child(4) {
      animation-delay: 0.3s;
      height: 50%;
    }

    .wave-bar:nth-child(5) {
      animation-delay: 0.4s;
      height: 40%;
    }

    @keyframes wave-animation {

      0%,
      100% {
        height: 20%;
        opacity: 0.5;
      }

      50% {
        height: 100%;
        opacity: 1;
      }
    }

    /* ----------------------------- */

    .relative .absolute {
      z-index: 10;
    }

    textarea:focus {
      border-color: #a855f7;
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    .voice-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .voice-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-top-color: #1f2937;
    }

    .voice-button-wrapper:hover .voice-tooltip {
      opacity: 1;
    }

    .textarea-error {
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
  </style>

  <style>
    /* ... (Keeping your existing font/card styles unchanged) ... */
    .poppins-thin {
      font-family: "Poppins", sans-serif;
      font-weight: 100;
      font-style: normal;
    }

    .course-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .course-card:hover {
      transform: translateY(-4px);
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .animate-bounce {
      animation: bounce 1s infinite;
    }

    .delay-150 {
      animation-delay: 0.15s;
    }

    .delay-300 {
      animation-delay: 0.3s;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #d8b4fe;
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #c084fc;
    }

    nav {
      position: sticky;
      top: 0;
      z-index: 50;
    }

    /* Minimized style fix */
    .chatbot-container.minimized .bg-white {
      overflow: hidden;
      height: 50px;
      cursor: pointer;
    }

    @media (max-width: 640px) {
      .chatbot-container {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
      }
    }

    .all-skills,
    .all-outcomes,
    .full-description {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .all-skills.expanded,
    .all-outcomes.expanded,
    .full-description.expanded {
      max-height: 500px;
    }

    .all-skills.expanded .bg-gray-100,
    .all-outcomes.expanded .text-gray-600,
    .full-description.expanded {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>

<body class="bg-violet-100 min-h-screen flex flex-col" style='font-family: "Manrope", sans-serif;'>

  <div id="page-loader" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center">
      <div class="flex space-x-2">
        <div class="w-4 h-4 bg-primary-600 rounded-full animate-bounce"></div>
        <div class="w-4 h-4 bg-primary-600 rounded-full animate-bounce delay-150"></div>
        <div class="w-4 h-4 bg-primary-600 rounded-full animate-bounce delay-300"></div>
      </div>
      <p class="text-white font-semibold mt-4">Searching for courses...</p>
    </div>
  </div>

  <nav class="bg-primary-700 shadow-md">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center space-x-2">
        <i class="fa-solid fa-graduation-cap text-white text-2xl"></i>
        <span class="text-xl font-bold text-white">UnifyLearn</span>
      </a>
      <div class="hidden md:block text-primary-100">
        Intelligent cross-platform course discovery
      </div>
    </div>
  </nav>

  <main class="flex-1 container mx-auto px-4 py-6">
    <% if (!courses || courses.length === 0) { %>
    <div id="guideSection" class="text-center max-w-3xl mx-auto mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">Discover Courses Smarter with UnifyLearn</h1>
      <p class="text-gray-600 text-lg mb-6">
        UnifyLearn helps you find the perfect learning resources across multiple platforms using natural language.
        Our AI assistant understands your learning needs and finds the most relevant courses for you.
      </p>

      <div class="bg-primary-50 border-l-4 border-primary-500 p-6 rounded-lg mb-8 text-left">
        <h3 class="font-semibold text-primary-800 mb-3 flex items-center">
          <i class="fas fa-lightbulb mr-2 text-primary-600"></i>
          How to use UnifyLearn:
        </h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
          <li>Type your learning request in the chat (e.g., "Python courses for beginners")</li>
          <li>Our AI will search across multiple learning platforms</li>
          <li>Browse the recommended courses and click to enroll</li>
        </ol>
      </div>

      <div class="flex flex-wrap justify-center gap-3 mb-8">
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">Coursera</span>
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">SimpliLearn</span>
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">Udacity</span>
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">FutureLearn</span>
      </div>
    </div>
    <% } %>

    <% if (courses && courses.length > 0) { %>
    <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Recommended Courses</h2>
    <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <% } else { %>
    <div class="text-center py-12 text-gray-500 col-span-full">
      <i class="fas fa-search text-gray-300 text-4xl mb-3"></i>
      <p>Open the chat in the bottom right corner to find courses.</p>
    </div>
    <% } %>
  </main>

  <footer class="bg-gray-800 text-white py-4 mt-4">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; <span id="current-year"><%= new Date().getFullYear() %></span> UnifyLearn. All rights reserved.</p>
    </div>
  </footer>

  <div class="chatbot-container fixed bottom-5 right-5 w-96 md:w-80 lg:w-96 z-50 h-max text-sm ">
    <div class="bg-white backdrop-blur-sm rounded-xl shadow-2xl border border-gray-200 overflow-hidden">

      <div class="flex justify-between items-center bg-primary-600 text-white px-4 py-3">
        <div class="flex items-center space-x-2">
          <i class="fas fa-robot"></i>
          <h3 class="font-semibold">UnifyBot</h3>
        </div>
        <div class="flex space-x-2">
          <button id="minimizeChat" class="bg-white/20 hover:bg-white/30 text-white rounded-full w-7 h-7 flex items-center justify-center transition-colors">
            <i class="fas fa-minus text-sm"></i>
          </button>
          <button id="closeChat" class="bg-white/20 hover:bg-white/30 text-white rounded-full w-7 h-7 flex items-center justify-center transition-colors">
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
      </div>

      <div class="border-t border-gray-100 bg-white">
        <div id="chatMessages" class="chat-messages h-80 overflow-y-auto p-4 bg-gray-50">
          <div class="flex mb-4">
            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
              <i class="fas fa-robot text-blue-600"></i>
            </div>
            <div class="bg-white border border-gray-200 rounded-lg rounded-tl-none px-4 py-2 max-w-[80%] text-sm shadow-sm">
              Hello! I am UnifyBot, your course discovery assistant. What would you like to learn today?
            </div>
          </div>
        </div>

        <div class="px-4 py-3 bg-white border-t border-gray-100">
          <div class="flex flex-col space-y-2">
            <div class="flex items-start space-x-2">
              <div class="flex-1 relative">
                <textarea id="userInput" placeholder="Ask about courses (e.g., Python for beginners)..." rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm resize-none min-h-[60px] max-h-[120px] transition-colors"></textarea>
                <div class="absolute bottom-1 right-2 text-xs text-gray-400 hidden" id="charCount">
                  <span id="charCountText">0</span>/500
                </div>
              </div>
            </div>

            <div class="flex justify-between items-center">
              <div class="voice-button-wrapper relative">
                <button id="voiceButton" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition-all duration-200 relative group" title="Voice Input (Ctrl+Space)" type="button">
                  <i class="fas fa-microphone"></i>
                </button>
                <div class="voice-tooltip">
                  Click to speak (Ctrl+Space)
                </div>
              </div>

              <button id="sendButton" class="bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" type="button">
                <span>Send</span>
                <i class="fas fa-paper-plane text-sm"></i>
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    window.__LOCAL_COURSES__ = <%- JSON.stringify(courses || []) %>;
    window.__CURRENT_TIMESTAMP__ = <%- JSON.stringify(locals.timestamp || '') %>;
    const CHAT_STORAGE_KEY = 'unifylearn_chat_history';
  </script>

  <script>
    class VoiceRecognition {
      constructor() {
        this.recognition = null;
        this.isListening = false;
        this.voiceButton = document.getElementById('voiceButton');
        this.userInput = document.getElementById('userInput');

        // State variables
        this.manualInput = '';
        this.sessionTranscript = '';

        this.init();
      }

      init() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          if (this.voiceButton) this.voiceButton.style.display = 'none';
          return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        this.setupRecognition();
        this.setupEventListeners();
      }

      setupRecognition() {
        this.recognition.continuous = true;
        this.recognition.interimResults = true;
        this.recognition.lang = 'en-US';

        this.recognition.onstart = () => {
          this.isListening = true;
          this.updateUIState(true);
          this.addListeningIndicator();
        };

        this.recognition.onresult = (event) => {
          let interimTranscript = '';
          let finalForThisSegment = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalForThisSegment += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          if (finalForThisSegment) {
            const prefix = (this.sessionTranscript.length > 0 || this.manualInput.length > 0) ? ' ' : '';
            this.sessionTranscript += prefix + finalForThisSegment;
          }

          let displayInterim = '';
          if (interimTranscript) {
            displayInterim = (this.sessionTranscript || this.manualInput) ? ' ' + interimTranscript : interimTranscript;
          }

          const totalText = this.manualInput + this.sessionTranscript + displayInterim;
          this.updateInput(totalText);
        };

        this.recognition.onerror = (event) => {
          if (event.error === 'no-speech') return;
          console.error('Speech error:', event.error);
          this.stopListening();
        };

        this.recognition.onend = () => {
          if (!this.isListening) {
            this.updateUIState(false);
            this.removeListeningIndicator();
          }
        };
      }

      setupEventListeners() {
        if (!this.voiceButton) return;
        this.voiceButton.addEventListener('click', (e) => {
          e.preventDefault();
          if (this.isListening) {
            this.stopListening();
          } else {
            this.startListening();
          }
        });
      }

      startListening() {
        this.recognition.abort();
        this.isListening = true;
        this.manualInput = this.userInput.value;
        this.sessionTranscript = '';
        try {
          this.recognition.start();
        } catch (error) {
          console.error("Mic start error:", error);
          this.isListening = false;
        }
      }

      stopListening() {
        this.isListening = false;
        try {
          this.recognition.stop();
        } catch (e) {}
        this.manualInput = this.userInput.value;
        this.sessionTranscript = '';
        this.updateUIState(false);
        this.removeListeningIndicator();
        this.updateCharCount();
      }

      resetState() {
        this.isListening = false;
        try {
          this.recognition.abort();
        } catch (e) {}
        this.manualInput = '';
        this.sessionTranscript = '';
        this.updateUIState(false);
        this.removeListeningIndicator();
      }

      updateUIState(listening) {
        if (listening) {
          this.voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
          this.voiceButton.classList.replace('bg-gray-100', 'bg-red-500');
          this.voiceButton.classList.replace('text-gray-700', 'text-white');
          this.voiceButton.classList.add('voice-listening');
        } else {
          this.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
          this.voiceButton.classList.replace('bg-red-500', 'bg-gray-100');
          this.voiceButton.classList.replace('text-white', 'text-gray-700');
          this.voiceButton.classList.remove('voice-listening');
        }
      }

      updateInput(text) {
        this.userInput.value = text;
        this.userInput.scrollTop = this.userInput.scrollHeight;
        this.userInput.style.height = 'auto';
        this.userInput.style.height = Math.min(this.userInput.scrollHeight, 120) + 'px';
        this.updateCharCount();
      }

      updateCharCount() {
        const charCount = document.getElementById('charCount');
        const charCountText = document.getElementById('charCountText');
        if (charCount && charCountText) {
          charCountText.textContent = this.userInput.value.length;
          charCount.classList.toggle('hidden', this.userInput.value.length === 0);
        }
      }

      // --- CHANGED: NEW WAVE ANIMATION LOGIC ---
      addListeningIndicator() {
        this.removeListeningIndicator();
        const indicator = document.createElement('div');
        indicator.id = 'listeningIndicator';
        // Improved styling for the text container
        indicator.className = 'flex items-center justify-between px-2 py-1 mb-2 bg-purple-50 rounded-lg border border-purple-100';

        // This inserts the wave HTML structure
        indicator.innerHTML = `
          <div class="flex items-center space-x-2">
            <div class="voice-wave-container">
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
            </div>
            <span class="text-xs font-semibold text-purple-700">Listening...</span>
          </div>
          <span class="text-[10px] text-gray-500">Tap mic to stop</span>`;

        this.userInput.parentNode.insertBefore(indicator, this.userInput);
      }
      // -----------------------------------------

      removeListeningIndicator() {
        const indicator = document.getElementById('listeningIndicator');
        if (indicator) indicator.remove();
      }

      showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-red-500 text-xs mt-1 absolute -bottom-6 left-0';
        errorDiv.innerText = message;
        this.voiceButton.parentNode.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 4000);
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      window.voiceApp = new VoiceRecognition();
      initializeChatbot();
      renderCoursesOriginal();
      setupToggles();
    });

    function renderCoursesOriginal() {
      const courses = window.__LOCAL_COURSES__;
      const resultsContainer = document.getElementById('results-container');
      const guideSection = document.getElementById('guideSection');

      if (courses && courses.length > 0) {
        if (!resultsContainer) {
          if (guideSection) guideSection.classList.add('hidden');
          const main = document.querySelector('main');
          const h2 = document.createElement('h2');
          h2.className = "text-3xl font-bold text-gray-800 mb-8 text-center";
          h2.innerText = "Recommended Courses";
          main.appendChild(h2);
          const newContainer = document.createElement('div');
          newContainer.id = 'results-container';
          newContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
          main.appendChild(newContainer);
          return renderCoursesOriginal();
        }

        import('/js/courseCard.js')
          .then(module => {
            resultsContainer.innerHTML = '';
            courses.forEach(course => {
              const col = document.createElement('div');
              col.className = 'course-col h-full';
              col.innerHTML = module.renderCourseCard(course);
              resultsContainer.appendChild(col);
            });
            if (guideSection) guideSection.classList.add('hidden');
          })
          .catch(err => {
            console.error("UI Load Error:", err);
            resultsContainer.innerHTML = '<p class="text-red-500 text-center">Error loading courseCard.js. Check file path.</p>';
          });
      }
    }

    function initializeChatbot() {
      const userInput = document.getElementById('userInput');
      const sendButton = document.getElementById('sendButton');

      loadChatHistory();

      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      window.addEventListener('beforeunload', () => {
        if (window.voiceApp) window.voiceApp.resetState();
      });
    }

    function sendMessage() {
      const userInput = document.getElementById('userInput');
      const query = userInput.value.trim();
      if (!query) return;

      const pageLoader = document.getElementById('page-loader');
      if (pageLoader) pageLoader.classList.remove('hidden');

      addMessage(query, 'user');
      if (window.voiceApp) window.voiceApp.resetState();
      userInput.value = '';
      userInput.style.height = 'auto';

      fetch('/query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            query
          })
        })
        .then(res => res.ok ? res.json() : Promise.reject('Network error'))
        .then(data => {
          if (pageLoader) pageLoader.classList.add('hidden');
          if (data.success) {
            addMessage(`Found ${data.total_results} courses! Redirecting...`, 'bot');
            setTimeout(() => {
              window.location.href = `/${data.timestamp}`;
            }, 1000);
          } else {
            addMessage(`Error: ${data.error}`, 'bot');
          }
        })
        .catch(err => {
          if (pageLoader) pageLoader.classList.add('hidden');
          addMessage('Error processing request.', 'bot');
          console.error(err);
        });
    }

    function addMessage(text, sender) {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;

      const div = document.createElement('div');
      div.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : ''}`;

      if (sender === 'user') {
        div.innerHTML = `
          <div class="bg-primary-600 text-white rounded-lg rounded-tr-none px-4 py-2 max-w-[80%] shadow-sm">${text}</div>
          <div class="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center ml-3 flex-shrink-0"><i class="fas fa-user text-primary-600"></i></div>`;
      } else {
        div.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0"><i class="fas fa-robot text-blue-600"></i></div>
          <div class="bg-white border border-gray-200 rounded-lg rounded-tl-none px-4 py-2 max-w-[80%] shadow-sm text-gray-800">${text}</div>`;
      }

      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      localStorage.setItem(CHAT_STORAGE_KEY, chatMessages.innerHTML);
    }

    function loadChatHistory() {
      const chatMessages = document.getElementById('chatMessages');
      const saved = localStorage.getItem(CHAT_STORAGE_KEY);
      if (saved && chatMessages) {
        chatMessages.innerHTML = saved;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    function setupToggles() {
      const wrapper = document.querySelector('.chatbot-container');
      const minBtn = document.getElementById('minimizeChat');
      const closeBtn = document.getElementById('closeChat');

      if (minBtn) minBtn.addEventListener('click', () => {
        wrapper.classList.toggle('minimized');
        const body = wrapper.querySelector('.border-t');
        if (body) body.classList.toggle('hidden');
      });

      if (closeBtn) closeBtn.addEventListener('click', () => {
        wrapper.classList.add('hidden');
      });
    }
  </script>
</body>

</html>
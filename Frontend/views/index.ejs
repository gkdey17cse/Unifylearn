<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Poppins:ital,wght@0,100;0,200;1,100;1,200;1,400&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#faf5ff',
              100: '#f3e8ff',
              200: '#e9d5ff',
              300: '#d8b4fe',
              400: '#c084fc',
              500: '#a855f7',
              600: '#9333ea',
              700: '#7e22ce',
              800: '#6b21a8',
              900: '#581c87',
            }
          },
          fontFamily: {
            // sans: ['Poppins', 'ui-sans-serif', 'system-ui'],
            sans: ['Lato', 'ui-sans-serif', 'system-ui'],
          },
        }
      }
    }
  </script>

  <style>
    .poppins-thin {
      font-family: "Poppins", sans-serif;
      font-weight: 100;
      font-style: normal;
    }

    .poppins-extralight {
      font-family: "Poppins", sans-serif;
      font-weight: 200;
      font-style: normal;
    }

    .poppins-thin-italic {
      font-family: "Poppins", sans-serif;
      font-weight: 100;
      font-style: italic;
    }

    .poppins-extralight-italic {
      font-family: "Poppins", sans-serif;
      font-weight: 200;
      font-style: italic;
    }

    .poppins-regular-italic {
      font-family: "Poppins", sans-serif;
      font-weight: 400;
      font-style: italic;
    }

    .course-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .course-card:hover {
      transform: translateY(-4px);
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .animate-bounce {
      animation: bounce 1s infinite;
    }

    .delay-150 {
      animation-delay: 0.15s;
    }

    .delay-300 {
      animation-delay: 0.3s;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #d8b4fe;
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #c084fc;
    }


    /* Make navbar sticky */
    nav {
      position: sticky;
      top: 0;
      z-index: 50;
    }

    /* Chatbot minimized style */
    .chatbot-container.minimized .bg-white/95 {
      overflow: hidden;
      height: 50px;
      cursor: pointer;
    }


    @media (max-width: 640px) {
      .chatbot-container {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
      }
    }

    /* Fix for expandable sections */
    .all-skills,
    .all-outcomes,
    .full-description {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .all-skills.expanded,
    .all-outcomes.expanded,
    .full-description.expanded {
      max-height: 500px;
      /* Adjust this value based on your content */
    }

    /* Ensure content is visible when expanded */
    .all-skills.expanded .bg-gray-100,
    .all-outcomes.expanded .text-gray-600,
    .full-description.expanded {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Loader -->
  <div id="page-loader" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="flex flex-col items-center">
      <div class="flex space-x-2">
        <div class="w-4 h-4 bg-primary-600 rounded-full animate-bounce"></div>
        <div class="w-4 h-4 bg-primary-600 rounded-full animate-bounce delay-150"></div>
        <div class="w-4 h-4 bg-primary-600 rounded-full animate-bounce delay-300"></div>
      </div>
      <p class="text-white font-semibold mt-4">Searching for courses...</p>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="bg-primary-700 shadow-md">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center space-x-2">
        <i class="fa-solid fa-graduation-cap text-white text-2xl"></i>
        <span class="text-xl font-bold text-white">UnifyLearn</span>
      </a>
      <div class="hidden md:block text-primary-100">
        Intelligent cross-platform course discovery
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 container mx-auto px-4 py-8">
    <% if (!courses || courses.length === 0) { %>
    <div id="guideSection" class="text-center max-w-3xl mx-auto mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">Discover Courses Smarter with UnifyLearn</h1>
      <p class="text-gray-600 text-lg mb-6">
        UnifyLearn helps you find the perfect learning resources across multiple platforms using natural language.
        Our AI assistant understands your learning needs and finds the most relevant courses for you.
      </p>

      <div class="bg-primary-50 border-l-4 border-primary-500 p-6 rounded-lg mb-8 text-left">
        <h3 class="font-semibold text-primary-800 mb-3 flex items-center">
          <i class="fas fa-lightbulb mr-2 text-primary-600"></i>
          How to use UnifyLearn:
        </h3>
        <ol class="list-decimal list-inside space-y-2 text-gray-700">
          <li>Type your learning request in the chat (e.g., "Python courses for beginners")</li>
          <li>Our AI will search across multiple learning platforms</li>
          <li>Browse the recommended courses and click to enroll</li>
          <li>Save interesting courses for later reference</li>
        </ol>
      </div>

      <div class="flex flex-wrap justify-center gap-3 mb-8">
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">Coursera</span>
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">Udemy</span>
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">edX</span>
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">FutureLearn</span>
        <span class="px-4 py-2 bg-primary-100 text-primary-700 rounded-full text-sm">Pluralsight</span>
      </div>
    </div>
    <% } %>

    <% if (courses && courses.length > 0) { %>
    <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Recommended Courses</h2>
    <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <% } else { %>
    <div class="text-center py-12 text-gray-500 col-span-full">
      <i class="fas fa-search text-gray-300 text-4xl mb-3"></i>
      <p>Open the chat in the bottom right corner to find courses.</p>
    </div>
    <% } %>
  </main>

  <footer class="bg-gray-800 text-white py-4 mt-4">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; <span id="current-year"><%= new Date().getFullYear() %></span> UnifyLearn. All rights reserved.</p>
    </div>
  </footer>

  <!-- Chatbot -->
  <!-- Chatbot -->
  <div class="chatbot-container fixed bottom-5 right-5 w-96 md:w-80 lg:w-96 z-50" style="font-family: "Lato", sans-serif;">
    <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200 overflow-hidden">
      <!-- Header -->
      <div class="flex justify-between items-center bg-primary-600 text-white px-4 py-3">
        <div class="flex items-center space-x-2">
          <i class="fas fa-robot"></i>
          <h3 class="font-semibold">UnifyBot</h3>
        </div>
        <div class="flex space-x-2">
          <!-- Minimize button -->
          <button id="minimizeChat" class="bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full w-7 h-7 flex items-center justify-center">
            <i class="fas fa-minus text-sm"></i>
          </button>
          <!-- Close button -->
          <button id="closeChat" class="bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full w-7 h-7 flex items-center justify-center">
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
      </div>

      <!-- Chat body -->
      <div class="border-t border-gray-200">
        <div id="chatMessages" class="chat-messages h-80 overflow-y-auto p-4 bg-gray-50/90">
          <div class="flex mb-4">
            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
              <i class="fas fa-robot text-blue-600"></i>
            </div>
            <div class="bg-gray-100 rounded-lg rounded-tl-none px-4 py-2 max-w-[80%] text-sm">
              Hello! I am UnifyBot, your course discovery assistant. What would you like to learn today?
            </div>
          </div>
        </div>

        <!-- Input -->
        <div class="px-4 py-3 bg-white border-t border-gray-200 flex">
          <input type="text" id="userInput" placeholder="Ask about courses (e.g., Python for beginners)..." class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm">
          <button id="sendButton" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-r-lg font-medium transition-colors">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const chatbotWrapper = document.getElementById('chatbotWrapper');
      const minimizeBtn = document.getElementById('minimizeChat');

      minimizeBtn.addEventListener('click', () => {
        if (chatbotWrapper.classList.contains('minimized')) {
          chatbotWrapper.classList.remove('minimized');
          chatbotWrapper.style.height = 'auto';
        } else {
          chatbotWrapper.classList.add('minimized');
          chatbotWrapper.style.height = '50px';
        }
      });
    });
  </script>


  <script>
    window.__LOCAL_COURSES__ = <%- JSON.stringify(courses || []) %>;
    window.__LOCAL_TEST_MESSAGE__ = <%- JSON.stringify(message || '') %>;
    window.__CURRENT_TIMESTAMP__ = <%- JSON.stringify(locals.timestamp || '') %>;
  </script>

  <script>
    const CHAT_STORAGE_KEY = 'unifylearn_chat_history';
    document.addEventListener('DOMContentLoaded', function() {
      initializeChatbot();
      renderCourses();

      // Event delegation for dynamically rendered course cards - FIXED VERSION
      document.addEventListener('click', function(e) {
        // Description toggle
        if (e.target.classList.contains('toggle-description')) {
          const desc = e.target.nextElementSibling;
          const isExpanded = desc.classList.contains('expanded');

          if (isExpanded) {
            desc.classList.remove('expanded');
            e.target.textContent = 'Read more';
          } else {
            desc.classList.add('expanded');
            e.target.textContent = 'Show less';
          }
        }

        // Skills toggle
        if (e.target.classList.contains('toggle-skills')) {
          const skillsContainer = e.target.closest('.mb-3');
          const allSkills = skillsContainer.querySelector('.all-skills');
          const isExpanded = allSkills.classList.contains('expanded');

          if (isExpanded) {
            allSkills.classList.remove('expanded');
            e.target.textContent = 'Show all';
          } else {
            allSkills.classList.add('expanded');
            e.target.textContent = 'Show less';
          }
        }

        // Outcomes toggle
        if (e.target.classList.contains('toggle-outcomes')) {
          const outcomesContainer = e.target.closest('.mb-3');
          const allOutcomes = outcomesContainer.querySelector('.all-outcomes');
          const isExpanded = allOutcomes.classList.contains('expanded');

          if (isExpanded) {
            allOutcomes.classList.remove('expanded');
            e.target.textContent = 'Show all';
          } else {
            allOutcomes.classList.add('expanded');
            e.target.textContent = 'Show less';
          }
        }
      });
    });

    function initializeChatbot() {
      const userInput = document.getElementById('userInput');
      const sendButton = document.getElementById('sendButton');
      const closeChat = document.getElementById('closeChat');

      sendButton.addEventListener('click', sendMessage);
      userInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') sendMessage();
      });
      closeChat.addEventListener('click', () => document.getElementById('chatbotWrapper').classList.add('hidden'));

      loadChatHistory();
    }

    function loadChatHistory() {
      const chatMessages = document.getElementById('chatMessages');
      const savedChat = localStorage.getItem(CHAT_STORAGE_KEY);
      if (savedChat && chatMessages) {
        chatMessages.innerHTML = savedChat;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    function saveChatHistory() {
      const chatMessages = document.getElementById('chatMessages');
      if (chatMessages) localStorage.setItem(CHAT_STORAGE_KEY, chatMessages.innerHTML);
    }

    function addMessage(text, sender) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : ''}`;

      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="bg-primary-600 text-white rounded-lg rounded-tr-none px-4 py-2 max-w-[80%]">
            ${text}
          </div>
          <div class="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center ml-3 flex-shrink-0">
            <i class="fas fa-user text-primary-600"></i>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
            <i class="fas fa-robot text-blue-600"></i>
          </div>
          <div class="bg-gray-100 rounded-lg rounded-tl-none px-4 py-2 max-w-[80%]">
            ${text}
          </div>
        `;
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      saveChatHistory();
    }

    function sendMessage() {
      const userInput = document.getElementById('userInput');
      const query = userInput.value.trim();
      if (!query) return;
      const pageLoader = document.getElementById('page-loader');
      if (pageLoader) pageLoader.classList.remove('hidden');

      addMessage(query, 'user');
      userInput.value = '';

      fetch('/query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            query
          })
        })
        .then(response => response.ok ? response.json() : Promise.reject('Network error'))
        .then(data => {
          if (pageLoader) pageLoader.classList.add('hidden');
          if (data.success) {
            addMessage(`Found ${data.total_results} courses! Redirecting...`, 'bot');
            saveChatHistory();
            setTimeout(() => {
              window.location.href = `/${data.timestamp}`;
            }, 1500);
          } else {
            addMessage(`Error: ${data.error}`, 'bot');
            saveChatHistory();
          }
        })
        .catch(err => {
          if (pageLoader) pageLoader.classList.add('hidden');
          addMessage('Error processing your request. Please try again.', 'bot');
          saveChatHistory();
          console.error(err);
        });
    }

    function renderCourses() {
      if (window.__LOCAL_COURSES__?.length > 0) {
        import('/js/courseCard.js')
          .then(module => {
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer) return;
            resultsContainer.innerHTML = '';
            window.__LOCAL_COURSES__.forEach(course => {
              const courseCol = document.createElement('div');
              courseCol.className = 'course-col';
              courseCol.innerHTML = module.renderCourseCard(course);
              resultsContainer.appendChild(courseCol);
            });
            const guideSection = document.getElementById('guideSection');
            if (guideSection) guideSection.classList.add('hidden');
          })
          .catch(console.error);
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const chatbotWrapper = document.querySelector('.chatbot-container');
      const minimizeBtn = document.getElementById('minimizeChat');
      const closeBtn = document.getElementById('closeChat');

      minimizeBtn.addEventListener('click', () => {
        chatbotWrapper.classList.toggle('minimized');
        const chatBody = chatbotWrapper.querySelector('div.border-t');
        if (chatBody.classList.contains('hidden')) {
          chatBody.classList.remove('hidden');
        } else {
          chatBody.classList.add('hidden');
        }
      });

      closeBtn.addEventListener('click', () => {
        chatbotWrapper.classList.add('hidden');
      });
    });
  </script>
</body>

</html>